{% extends "base.html" %}

{% block title %}Trang Ch·ªß - MiniSocial{% endblock %}

{% block content %}
    {% if session.logged_in_user_id %}
    <div class="card post-creation-area">
        <h3 style="margin-top:0; margin-bottom:1rem;">T·∫°o b√†i ƒëƒÉng m·ªõi</h3>
        {# Thay ƒë·ªïi form ƒë·ªÉ g·ª≠i file #}
        <form id="createPostForm" enctype="multipart/form-data">
            <textarea name="content" id="postContent" rows="3" placeholder="B·∫°n ƒëang nghƒ© g√¨, {{ session.username }}?"></textarea>
            <div class="file-input-wrapper">
                <label for="mediaFile">Th√™m ·∫£nh/video (t·ªëi ƒëa 25MB):</label>
                <input type="file" name="mediaFile" id="mediaFile" accept="image/*,video/*" onchange="previewMedia(event)">
            </div>
            <div id="mediaPreview" style="margin-bottom:1rem;"></div>
            <button type="button" onclick="submitPostWithMedia()">ƒêƒÉng b√†i</button> {# ƒê·ªïi th√†nh type="button" #}
        </form>
    </div>

    <h2 class="feed-title">B√†i ƒëƒÉng m·ªõi nh·∫•t</h2>
    <div id="postsContainer"> {# B√†i ƒëƒÉng s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y #}
        {% include '_posts_list.html' with context %} {# T√°ch ph·∫ßn l·∫∑p b√†i ƒëƒÉng ra file ri√™ng #}
    </div>
    
    {# Pagination links #}
    {% if pagination and (pagination.has_prev or pagination.has_next) %}
    <nav class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for('index', page=pagination.prev_num) }}">&laquo; M·ªõi h∆°n</a>
        {% else %}
            <span class="disabled">&laquo; M·ªõi h∆°n</span>
        {% endif %}

        {% for p_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p_num %}
                {% if pagination.page == p_num %}
                    <span class="current">{{ p_num }}</span>
                {% else %}
                    <a href="{{ url_for('index', page=p_num) }}">{{ p_num }}</a>
                {% endif %}
            {% else %}
                <span class="disabled">&hellip;</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
            <a href="{{ url_for('index', page=pagination.next_num) }}">C≈© h∆°n &raquo;</a>
        {% else %}
            <span class="disabled">C≈© h∆°n &raquo;</span>
        {% endif %}
    </nav>
    {% endif %}

    {% else %}
    <div class="card" style="text-align:center; padding: 2.5rem;">
        <h2 class="page-title">Ch√†o m·ª´ng ƒë·∫øn v·ªõi MiniSocial!</h2>
        <p style="margin-bottom:1.5rem;">N∆°i chia s·∫ª m·ªçi kho·∫£nh kh·∫Øc.</p>
        <a href="{{ url_for('login') }}"><button>ƒêƒÉng nh·∫≠p</button></a>
        <a href="{{ url_for('register') }}" style="margin-left:1rem;"><button style="background-color:var(--secondary-color);">ƒêƒÉng k√Ω</button></a>
    </div>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
{% if session.logged_in_user_id %}
<script>
    const apiUrlBase = "{{ url_for('index', _external=True) }}api"; // _external=True kh√¥ng c·∫ßn thi·∫øt n·∫øu API c√πng domain
    let latestPostTimestamp = null; // L∆∞u timestamp c·ªßa b√†i m·ªõi nh·∫•t ƒë√£ hi·ªÉn th·ªã

    function previewMedia(event) {
        const preview = document.getElementById('mediaPreview');
        preview.innerHTML = ''; // X√≥a preview c≈©
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    preview.appendChild(video);
                }
            }
            reader.readAsDataURL(file);
        }
    }

    async function submitPostWithMedia() {
        const form = document.getElementById('createPostForm');
        const formData = new FormData(form);
        // const content = document.getElementById('postContent').value;
        // const mediaFile = document.getElementById('mediaFile').files[0];
        // if (!content.trim() && !mediaFile) {
        //     alert('B√†i ƒëƒÉng ph·∫£i c√≥ n·ªôi dung ho·∫∑c file ƒëa ph∆∞∆°ng ti·ªán!');
        //     return;
        // }
        try {
            const response = await fetch(`${apiUrlBase}/posts`, {
                method: 'POST',
                body: formData, // G·ª≠i FormData, kh√¥ng c·∫ßn set Content-Type header
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server"}));
                throw new Error(errorData.error || `L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫°o b√†i ƒëƒÉng.`);
            }
            const newPostData = await response.json();
            prependPostToDOM(newPostData); // Th√™m b√†i m·ªõi l√™n ƒë·∫ßu
            form.reset(); // Reset form
            document.getElementById('mediaPreview').innerHTML = ''; // X√≥a preview
            if (!latestPostTimestamp || newPostData.timestamp > latestPostTimestamp) {
                latestPostTimestamp = newPostData.timestamp;
            }
        } catch (error) {
            console.error("L·ªói t·∫°o b√†i ƒëƒÉng:", error);
            alert(error.message);
        }
    }

    function formatPostTimestamp(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString); // JS Date t·ª± hi·ªÉu ISO string c√≥ Z l√† UTC
        return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' l√∫c ' +
               date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }
    
    function createPostElement(postData) {
        const postDiv = document.createElement('div');
        postDiv.className = 'card post';
        postDiv.dataset.id = postData.id;
        postDiv.id = `post-${postData.id}`; // Th√™m ID cho post element

        let mediaHTML = '';
        if (postData.media_url) {
            const mediaPath = `{{ url_for('static', filename='uploads/posts_media/') }}${postData.media_url}`;
            if (postData.media_type === 'image') {
                mediaHTML = `<div class="post-media"><img src="${mediaPath}" alt="N·ªôi dung media"></div>`;
            } else if (postData.media_type === 'video') {
                mediaHTML = `<div class="post-media"><video src="${mediaPath}" controls></video></div>`;
            }
        }
        
        const authorAvatarUrl = postData.avatar ? `{{ url_for('static', filename='uploads/avatars/') }}${postData.avatar}` : '';
        const authorAvatarInitial = postData.user ? postData.user[0].toUpperCase() : 'U';

        postDiv.innerHTML = `
            <div class="post-header">
                <div class="avatar avatar-sm">
                    ${postData.avatar ? `<img src="${authorAvatarUrl}" alt="Avatar">` : authorAvatarInitial}
                </div>
                <div class="post-user-time">
                    <strong><a href="/profile/${postData.user}">${postData.user}</a></strong>
                    <span>${formatPostTimestamp(postData.timestamp)}</span>
                </div>
            </div>
            ${postData.content ? `<div class="post-content">${escapeHTML(postData.content)}</div>` : ''}
            ${mediaHTML}
            <div class="post-actions">
                <button onclick="likePostAPI(${postData.id})">üëç Th√≠ch (<span id="likes-${postData.id}">${postData.likes}</span>)</button>
                <button onclick="toggleCommentForm(${postData.id})">üí¨ B√¨nh lu·∫≠n</button>
            </div>
            <div class="comments-section" id="comments-section-${postData.id}">
                <p class="no-content" id="no-comments-${postData.id}" style="font-size:0.85em; padding:5px 0;">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
            </div>
            <div class="comment-form" id="comment-form-${postData.id}" style="display:none;">
                <input type="text" id="commentText-${postData.id}" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                <button onclick="submitCommentAPI(${postData.id})">G·ª≠i</button>
            </div>
        `;
        return postDiv;
    }

    function prependPostToDOM(postData) {
        const postsContainer = document.getElementById('postsContainer');
        const noPostsMessage = postsContainer.querySelector('.no-content');
        if (noPostsMessage) {
            noPostsMessage.remove(); // X√≥a th√¥ng b√°o "Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o"
        }
        const postElement = createPostElement(postData);
        postsContainer.prepend(postElement); // Th√™m l√™n ƒë·∫ßu
    }
    
    function escapeHTML(str) { // C·∫ßn h√†m n√†y n·∫øu content c√≥ th·ªÉ ch·ª©a HTML
        if (str === null || str === undefined) return '';
        return str.replace(/[&<>"']/g, function (match) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
    }

    async function fetchNewPosts() {
        try {
            let url = `${apiUrlBase}/latest`;
            if (latestPostTimestamp) {
                url += `?since=${latestPostTimestamp}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
                console.error("L·ªói fetch b√†i ƒëƒÉng m·ªõi:", response.status);
                return;
            }
            const newPosts = await response.json();
            if (newPosts && newPosts.length > 0) {
                newPosts.forEach(post => {
                    // Ki·ªÉm tra xem b√†i ƒëƒÉng ƒë√£ c√≥ tr√™n trang ch∆∞a ƒë·ªÉ tr√°nh tr√πng l·∫∑p (quan tr·ªçng)
                    if (!document.getElementById(`post-${post.id}`)) {
                        prependPostToDOM(post);
                    }
                });
                // C·∫≠p nh·∫≠t timestamp c·ªßa b√†i m·ªõi nh·∫•t
                latestPostTimestamp = newPosts[0].timestamp; // Gi·∫£ s·ª≠ API tr·∫£ v·ªÅ s·∫Øp x·∫øp m·ªõi nh·∫•t tr∆∞·ªõc
            }
        } catch (error) {
            console.error("L·ªói fetch b√†i ƒëƒÉng m·ªõi:", error);
        }
    }
    
    // L·∫•y timestamp c·ªßa b√†i ƒëƒÉng m·ªõi nh·∫•t hi·ªán c√≥ tr√™n trang (n·∫øu c√≥)
    function initializeLatestTimestamp() {
        const firstPost = document.querySelector('#postsContainer .post');
        if (firstPost) {
            // Gi·∫£ s·ª≠ timestamp ƒë∆∞·ª£c l∆∞u trong m·ªôt data-attribute ho·∫∑c c√≥ th·ªÉ l·∫•y t·ª´ text
            // Trong v√≠ d·ª• n√†y, ch√∫ng ta s·∫Ω ƒë·ªÉ `latestPostTimestamp` l√† null ban ƒë·∫ßu,
            // v√† API s·∫Ω tr·∫£ v·ªÅ c√°c b√†i ƒëƒÉng m·ªõi nh·∫•t.
            // ƒê·ªÉ t·ªëi ∆∞u h∆°n, b·∫°n c√≥ th·ªÉ g·ª≠i timestamp c·ªßa b√†i ƒëƒÉng ƒë·∫ßu ti√™n hi·ªán t·∫°i l√™n server.
        }
    }

    // C√°c h√†m likePostAPI, toggleCommentForm, submitCommentAPI gi·ªØ nguy√™n nh∆∞ file `index.html` tr∆∞·ªõc ƒë√≥
    // nh∆∞ng c·∫ßn ƒëi·ªÅu ch·ªânh ƒë·ªÉ c·∫≠p nh·∫≠t DOM ho·∫∑c g·ªçi l·∫°i fetchNewPosts/reload.
    // V√≠ d·ª• submitCommentAPI sau khi th√†nh c√¥ng:
    // async function submitCommentAPI(postId) { ... try { ... const newCommentData = await response.json(); addCommentToDOM(postId, newCommentData); ... } ... }
    // ƒê·ªÉ ƒë∆°n gi·∫£n, reload v·∫´n ƒë∆∞·ª£c ch·∫•p nh·∫≠n cho phi√™n b·∫£n n√†y.
    // C√°c h√†m n√†y ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l·∫°i trong c√°c file tr∆∞·ªõc, c√≥ th·ªÉ copy qua.
    // (Gi·ªØ l·∫°i c√°c h√†m ƒë√£ c√≥ trong phi√™n b·∫£n tr∆∞·ªõc)
    async function likePostAPI(postId) { /* ... nh∆∞ c≈© ... */ }
    function toggleCommentForm(postId) { /* ... nh∆∞ c≈© ... */ }
    async function submitCommentAPI(postId) { /* ... nh∆∞ c≈©, nh∆∞ng sau khi th√†nh c√¥ng c√≥ th·ªÉ g·ªçi h√†m render comment m·ªõi thay v√¨ reload ... */ 
        const commentTextInput = document.getElementById(`commentText-${postId}`);
        if (!commentTextInput) return;
        const commentContent = commentTextInput.value.trim();

        if (!commentContent) { alert('N·ªôi dung b√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!'); return; }
        try {
            const response = await fetch(`${apiUrlBase}/posts/${postId}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_content: commentContent }),
            });
            if (!response.ok) throw new Error(`L·ªói ${response.status}: Kh√¥ng th·ªÉ b√¨nh lu·∫≠n.`);
            const newCommentData = await response.json();
            addCommentToDOM(postId, newCommentData); // G·ªçi h√†m n√†y
            commentTextInput.value = '';
            // toggleCommentForm(postId); // Optionally hide form
        } catch (error) {
            console.error("L·ªói b√¨nh lu·∫≠n:", error);
            alert(error.message);
        }
    }

    function addCommentToDOM(postId, commentData) {
       const commentsSection = document.getElementById(`comments-section-${postId}`);
       const noCommentsEl = document.getElementById(`no-comments-${postId}`);
       if(noCommentsEl) noCommentsEl.style.display = 'none'; // ·∫®n th√¥ng b√°o "ch∆∞a c√≥ b√¨nh lu·∫≠n"
   
       const commentDiv = document.createElement('div');
       commentDiv.className = 'comment';
       commentDiv.id = `comment-${commentData.id}`;
       
       const commenterAvatarUrl = commentData.avatar ? `{{ url_for('static', filename='uploads/avatars/') }}${commentData.avatar}` : (currentUserAvatarUrl && commentData.user === currentUsername ? currentUserAvatarUrl : '');
       const commenterAvatarInitial = commentData.user ? commentData.user[0].toUpperCase() : 'U';

       commentDiv.innerHTML = `
           <div class="post-header" style="margin-bottom: 0.3rem;">
               <div class="avatar avatar-sm" style="width:30px; height:30px; font-size:0.8em; margin-right:0.5rem;">
                   ${commenterAvatarUrl ? `<img src="${commenterAvatarUrl}" alt="Avatar">` : commenterAvatarInitial}
               </div>
               <div>
                   <strong><a href="/profile/${escapeHTML(commentData.user)}">${escapeHTML(commentData.user)}</a></strong>
                   <span class="comment-timestamp">${formatPostTimestamp(commentData.timestamp)}</span>
               </div>
           </div>
           ${escapeHTML(commentData.text)}
       `;
       commentsSection.appendChild(commentDiv); // Th√™m b√¨nh lu·∫≠n m·ªõi v√†o cu·ªëi
    }


    // Kh·ªüi ch·∫°y auto-refresh v√† c√°c thi·∫øt l·∫≠p ban ƒë·∫ßu
    document.addEventListener('DOMContentLoaded', () => {
        initializeLatestTimestamp();
        setInterval(fetchNewPosts, 30000); // 30 gi√¢y m·ªôt l·∫ßn
    });

</script>
{% endif %}
{% endblock %}
